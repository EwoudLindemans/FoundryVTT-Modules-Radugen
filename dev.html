<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Radugen Experiments</title>
    <script type="text/javascript" src="scripts/helper.js"></script>
    <script type="text/javascript" src="scripts/classes/tiles/tile.js"></script>
    <script type="text/javascript" src="scripts/classes/tiles/tileGrid.js"></script>
    <script type="text/javascript" src="scripts/dungeons/dungeon.js"></script>
    <script type="text/javascript" src="scripts/dungeons/generators/genV1.js"></script>
    <script type="text/javascript" src="scripts/dungeons/generators/genV2.js"></script>
    <script type="text/javascript" src="scripts/dungeons/generators/layoutV1.js"></script>
    <script type="text/javascript" src="scripts/dungeons/generators/maze.js"></script>
    <script type="text/javascript" src="scripts/dungeons/generators/names.js"></script>
    <script type="text/javascript" src="scripts/dungeons/generators/rooms/crossRoomGenerator.js"></script>
    <script type="text/javascript" src="scripts/dungeons/generators/rooms/randomRoomGenerator.js"></script>
    <script type="text/javascript" src="scripts/dungeons/generators/rooms/rooms.js"></script>
    <script type="text/javascript" src="scripts/dungeons/pathfinding/adjecentPathfinding.js"></script>
    <script type="text/javascript">
        function fillSelect(id, dictionary) {
            const storageValue = localStorage.getItem(`radugen-${id}`);
            let html = '';
            for (let key of Object.keys(dictionary)) {
                const selected = (storageValue === dictionary[key].toString());
                html += `<option value="${dictionary[key]}"${selected ? ' selected' : ''}>${key}</option>`;
            }
            document.getElementById(id).innerHTML = html;
        }

        function getSelect(id) {
            return parseInt(document.getElementById(id).value);
        }

        document.addEventListener("DOMContentLoaded", () => {
            fillSelect('dungeon-generator', radugen.generators.dungeonGenerator);
            fillSelect('dungeon-size', radugen.generators.dungeonSize);

            document.getElementById('dungeon-generate').addEventListener('click', () => {
                const canvas = document.getElementById('output-canvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                document.getElementById('dungeon-name').innerHTML = 'Loading...';

                const [generator, size] = [getSelect('dungeon-generator'), getSelect('dungeon-size')];

                localStorage.setItem('radugen-dungeon-generator', generator);
                localStorage.setItem('radugen-dungeon-size', size);

                const dungeon = radugen.generators.dungeon.generate(generator, size);
                const tileSize = 8;
                
                const grid = dungeon.rasterize();

                canvas.width = grid.width * tileSize;
                canvas.height = grid.height * tileSize;

                grid.iterate((tile, x, y) => {
                    if (tile == 0) return;
                    ctx.fillStyle = tile == 99 ? "red" : "black";
                    ctx.fillRect(tileSize * x, tileSize * y, tileSize, tileSize);
                });

                ctx.save();
                ctx.font = '12px sans-serif';
                ctx.fillStyle = '#fff';
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                for (let ri in dungeon._rooms) {
                    const rect = dungeon._rooms[ri]
                    let [posX, posY] = [rect.centerX * tileSize, rect.centerY * tileSize];
                    ctx.fillText(ri.toString(), posX, posY);
                }

                document.getElementById('dungeon-name').innerHTML = radugen.generators.names.dungeonName();
            });
        });
    </script>
    <style type="text/css" rel="stylesheet">
        html, body {
            font-family: sans-serif;
        }

        [Options] {
            display: block;
            float: left;
            margin-right: 16px;
            width: 320px;
        }

        [Options] label {
            margin-bottom: 1em;
        }

        [Options] label,
        [Options] select,
        [Options] input {
            clear: none;
            width: 100%;
        }

        [Output] {
            display: block;
            float: left;
        }

        [Output] canvas {
            border: solid 1px #ddd;
        }
    </style>
</head>

<body>
    <h1>Radugen Experiments</h1>
    <div Options>
        <h2>Generate dungeon</h2>
        <label style="width:100%;display:block">Generator:
            <select id="dungeon-generator"></select>
        </label>
        <label style="width:100%;display:block">Size:
            <select id="dungeon-size"></select>
        </label>
        <input id="dungeon-generate" type="button" value="Generate Dungeon" />
    </div>
    <div Output style="display: block; float:left">
        <h2 id="dungeon-name">Output</h2>
        <canvas id="output-canvas" width="64" height="64" />
    </div>
</body>

</html>